<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Bare Bones Debug</title>
    <style>
        body {
            margin: 0;
            background: #888;
        }
    </style>
</head>

<body>
    <script type="module">
        import * as THREE from './three.module.js';
        import { GLTFLoader } from './GLTFLoader.js';
        import { OrbitControls } from './OrbitControls.js';
        import { RoomEnvironment } from './RoomEnvironment.js';

        const renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);

        const scene = new THREE.Scene();
        const pmremGenerator = new THREE.PMREMGenerator(renderer);
        scene.environment = pmremGenerator.fromScene(new RoomEnvironment(), 0.04).texture;

        const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.5, 3);

        const controls = new OrbitControls(camera, renderer.domElement);

        const light = new THREE.DirectionalLight(0xffffff, 2);
        light.position.set(1, 1, 1);
        scene.add(light);

        const loader = new GLTFLoader();
        loader.load('model.glb', (gltf) => {
            scene.add(gltf.scene);
            console.log("Model loaded.");
            gltf.scene.traverse(child => {
                if (child.isMesh && child.name.includes('body')) {
                    console.log(`Mesh: ${child.name}`);
                    if (child.material.map && child.material.map.image) {
                        console.log("Found texture map. Displaying it...");
                        const img = document.createElement('img');
                        img.src = child.material.map.image.src; // Works if it's a blob url
                        // If it's an ImageBitmap, we might need a canvas
                        if (child.material.map.image instanceof ImageBitmap) {
                            const canvas = document.createElement('canvas');
                            canvas.width = child.material.map.image.width;
                            canvas.height = child.material.map.image.height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(child.material.map.image, 0, 0);
                            img.src = canvas.toDataURL();
                        }

                        img.style.position = 'absolute';
                        img.style.top = '10px';
                        img.style.left = '10px';
                        img.style.width = '300px';
                        img.style.border = '2px solid red';
                        img.style.zIndex = '9999';
                        document.body.appendChild(img);
                    } else {
                        const div = document.createElement('div');
                        div.innerText = 'No Texture Map Found on Body';
                        div.style.color = 'red';
                        div.style.fontSize = '30px';
                        document.body.appendChild(div);
                    }
                }
            });
        });

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();
    </script>
</body>

</html>